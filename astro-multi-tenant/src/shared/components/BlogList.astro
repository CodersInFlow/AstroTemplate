---
// Shared blog listing component
export interface Props {
  database: string;
  apiUrl?: string;
  category?: string;
}

const { database, apiUrl = 'http://127.0.0.1:3001', category } = Astro.props;

// Fetch blog posts
const url = category 
  ? `${apiUrl}/api/posts?type=blog&category=${category}`
  : `${apiUrl}/api/posts?type=blog`;

const response = await fetch(url, {
  headers: {
    'X-Site-Database': database
  }
});

const posts = response.ok ? await response.json() : [];

// Fetch categories
const catResponse = await fetch(`${apiUrl}/api/categories?type=blog`, {
  headers: {
    'X-Site-Database': database
  }
});
const categories = catResponse.ok ? await catResponse.json() : [];
---

<div>
  <!-- Category Filter -->
  <div class="flex gap-2 flex-wrap mb-8">
    <a href="/blog" class={`px-4 py-2 rounded-full transition ${!category ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}`}>
      All
    </a>
    {categories.map((cat: any) => (
      <a 
        href={`/blog?category=${cat.slug}`} 
        class={`px-4 py-2 rounded-full transition ${category === cat.slug ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}`}
      >
        {cat.name}
      </a>
    ))}
  </div>

  <!-- Blog Posts Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {posts.map((post: any) => (
      <a href={`/blog/${post.slug}`} class="block">
        <article class="bg-gray-900 rounded-lg p-6 hover:bg-gray-800 transition h-full">
          <h2 class="text-xl font-bold mb-2">{post.title}</h2>
          <p class="text-gray-400 mb-4">{post.excerpt || ''}</p>
          <div class="text-sm text-gray-500">
            {new Date(post.createdAt).toLocaleDateString()}
          </div>
        </article>
      </a>
    ))}
  </div>
</div>