---
export const prerender = false;

import AstroRichTextEditor from './AstroRichTextEditor';
import './editor-styles.css';

const { database, tenant, theme } = Astro.props;

// Auth handled by middleware
const token = Astro.cookies.get('auth-token');

// Get post type from query params
const postType = Astro.url.searchParams.get('type') || 'blog';

// Fetch categories
const API_URL = 'http://127.0.0.1:3001';
let categories = [];
try {
  const categoriesResponse = await fetch(`${API_URL}/api/categories?type=${postType}`, {
    headers: {
      'Cookie': `auth-token=${token.value}`,
      'X-Site-Database': database
    }
  });
  if (categoriesResponse.ok) {
    categories = await categoriesResponse.json();
  }
} catch (error) {
  console.error('Failed to fetch categories:', error);
}
---

<div class="min-h-screen bg-gray-900">
  <!-- Editor Header -->
  <header class="bg-gray-800 border-b border-gray-700">
    <div class="container mx-auto px-4 py-4">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold text-white">Create New {postType === 'blog' ? 'Blog Post' : 'Documentation'}</h1>
        <a href="/blog/editor" class="text-gray-400 hover:text-white transition-colors">
          ‚Üê Back to Dashboard
        </a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8 max-w-4xl">
    <form id="postForm" class="space-y-6">
      <input type="hidden" name="type" value={postType} />
      
      <!-- Title -->
      <div>
        <label for="title" class="block text-sm font-medium mb-2 text-gray-300">Title</label>
        <input
          type="text"
          id="title"
          name="title"
          required
          class="w-full px-3 py-2 bg-gray-800 text-white border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Enter post title"
        />
      </div>

      <!-- Slug -->
      <div>
        <label for="slug" class="block text-sm font-medium mb-2 text-gray-300">
          Slug (URL)
          <span class="text-gray-400 text-xs ml-2">Leave empty to auto-generate</span>
        </label>
        <input
          type="text"
          id="slug"
          name="slug"
          class="w-full px-3 py-2 bg-gray-800 text-white border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="post-url-slug"
        />
      </div>

      <!-- Description -->
      <div>
        <label for="description" class="block text-sm font-medium mb-2 text-gray-300">Description</label>
        <textarea
          id="description"
          name="description"
          required
          rows="3"
          class="w-full px-3 py-2 bg-gray-800 text-white border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Brief description for listing pages"
        ></textarea>
      </div>

      <!-- Category -->
      <div>
        <label for="category" class="block text-sm font-medium mb-2 text-gray-300">Category</label>
        <select
          id="category"
          name="category"
          class="w-full px-3 py-2 bg-gray-800 text-white border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="">Select a category (optional)</option>
          {categories.map((cat: any) => (
            <option value={cat._id || cat.id}>{cat.name}</option>
          ))}
        </select>
      </div>

      <!-- Content -->
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-300">Content</label>
        <AstroRichTextEditor 
          client:load
          content=""
          placeholder="Start writing your content..."
          inputId="content"
        />
        <input type="hidden" id="content" name="content" />
      </div>

      <!-- Published Status -->
      <div class="flex items-center gap-2">
        <input
          type="checkbox"
          id="published"
          name="published"
          checked
          class="rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-500"
        />
        <label for="published" class="text-gray-300">Publish immediately</label>
      </div>

      <!-- Messages -->
      <div id="error" class="text-red-400 hidden"></div>
      <div id="success" class="text-green-400 hidden"></div>

      <!-- Buttons -->
      <div class="flex gap-4">
        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
          Create Post
        </button>
        <a href="/blog/editor" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-md font-medium transition-colors inline-block">
          Cancel
        </a>
      </div>
    </form>
  </main>
</div>

<script define:vars={{ database }}>
  const form = document.getElementById('postForm');
  const errorDiv = document.getElementById('error');
  const successDiv = document.getElementById('success');
  
  // Auto-generate slug from title
  const titleInput = document.getElementById('title');
  const slugInput = document.getElementById('slug');
  
  titleInput?.addEventListener('input', () => {
    if (!slugInput.dataset.manual) {
      const slug = titleInput.value
        .toLowerCase()
        .replace(/[^a-z0-9\s]+/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-+|-+$/g, '');
      slugInput.value = slug;
    }
  });
  
  slugInput?.addEventListener('input', () => {
    slugInput.dataset.manual = 'true';
  });
  
  // Form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    
    // Get content from either the hidden input or window object (fallback)
    const contentValue = formData.get('content') || window.__editorContent || '';
    
    const data = {
      title: formData.get('title'),
      slug: formData.get('slug') || undefined,
      description: formData.get('description'),
      content: contentValue,
      type: formData.get('type'),
      category: formData.get('category') || undefined,
      published: formData.get('published') === 'on'
    };
    
    try {
      errorDiv.classList.add('hidden');
      successDiv.textContent = 'Creating post...';
      successDiv.classList.remove('hidden');
      
      const response = await fetch('http://127.0.0.1:3001/api/posts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Site-Database': database
        },
        credentials: 'include',
        body: JSON.stringify(data)
      });
      
      if (response.ok) {
        const post = await response.json();
        successDiv.textContent = 'Post created successfully! Redirecting...';
        setTimeout(() => {
          window.location.href = '/blog/editor';
        }, 1000);
      } else {
        const text = await response.text();
        errorDiv.textContent = text || 'Failed to create post';
        errorDiv.classList.remove('hidden');
        successDiv.classList.add('hidden');
      }
    } catch (error) {
      errorDiv.textContent = 'Network error. Please try again.';
      errorDiv.classList.remove('hidden');
      successDiv.classList.add('hidden');
    }
  });
</script>