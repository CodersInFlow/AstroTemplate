---
// ONE layout to rule them all!
import { getTenantFromHost } from '../shared/lib/tenant';
import DevModeOverlay from '../shared/components/Dev/DevModeOverlay.tsx';

// Import all configs, styles, and data using import.meta.glob
const configs = import.meta.glob('../sites/*/config.json', { eager: true });
const styles = import.meta.glob('../sites/*/styles/main.css', { eager: true, query: '?raw', import: 'default' });
const navbarDataFiles = import.meta.glob('../sites/*/data/navbar.json', { eager: true });
const footerDataFiles = import.meta.glob('../sites/*/data/footer.json', { eager: true });

// Get current tenant from hostname
const hostname = Astro.request.headers.get('host') || '';
const tenant = getTenantFromHost(hostname, Astro.url.searchParams);
const tenantDir = tenant.directory || tenant.id;

// Load tenant-specific config and styles from glob imports
const configPath = `../sites/${tenantDir}/config.json`;
const stylePath = `../sites/${tenantDir}/styles/main.css`;
const navbarPath = `../sites/${tenantDir}/data/navbar.json`;
const footerPath = `../sites/${tenantDir}/data/footer.json`;

const config = configs[configPath]?.default || {};
const siteStyles = styles[stylePath] || '';
const navbarData = navbarDataFiles[navbarPath]?.default || null;
const footerData = footerDataFiles[footerPath]?.default || null;

// Dynamic imports for nav/footer components based on site needs
let TopNavBar = null;
let Footer = null;

// Only import components if we have data for them
if (navbarData) {
  TopNavBar = (await import('../shared/components/Navigation/TopNavBarData.astro')).default;
}
if (footerData) {
  Footer = (await import('../shared/components/Footer/FooterData.jsx')).default;
}

const { title = config.name || 'Site', showNav = true, showFooter = true } = Astro.props;
const isDevelopment = import.meta.env.DEV;

// Get fonts from config
const googleFonts = config.fonts?.google || 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap';
---

<!DOCTYPE html>
<html lang="en" data-tenant={tenantDir}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={config.description || ''} />
    <title>{title}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href={`/favicon-${tenantDir.replace('.com', '')}.svg`} />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href={googleFonts} rel="stylesheet" />
    
    <!-- Inject the tenant's generated Tailwind CSS -->
    <style set:html={siteStyles}></style>
  </head>
  
  <body class={`tenant-${tenantDir.replace('.', '-')} bg-background text-text-primary`}>
    <!-- Navigation (if site has it) -->
    {showNav && navbarData && TopNavBar && (
      <TopNavBar data={navbarData} />
    )}
    
    <!-- Page content -->
    <slot />
    
    <!-- Footer (if site has it) -->
    {showFooter && footerData && Footer && (
      <Footer data={footerData} />
    )}
    
    <!-- Dev overlay in development -->
    {isDevelopment && <DevModeOverlay client:load />}
  </body>
</html>

<style>
  /* Tenant-specific scoping - NO global styles! */
  [data-tenant] {
    min-height: 100vh;
    margin: 0;
    padding: 0;
  }
  
  /* Each tenant's styles are scoped to their class */
  .tenant-prestongarrison-com {
    /* Prestongarrison specific overrides if needed */
  }
  
  .tenant-darkflows-com {
    /* Darkflows specific overrides if needed */
  }
  
  .tenant-default {
    /* Default site specific overrides if needed */
  }
</style>