---
import Layout from '../layout.astro';
import { getSitesConfig } from '../../../shared/lib/tenant';

const sites = getSitesConfig();
const isDevelopment = import.meta.env.DEV;
const DEV_FRONTEND_PORT = import.meta.env.PUBLIC_DEV_FRONTEND_PORT || '4321';

// Prepare sites for dropdown - welcome first, then others
const displaySites = [
  // Add welcome site first
  {
    domain: 'welcome.localhost',
    name: 'Platform Overview',
    url: `http://welcome.localhost:${DEV_FRONTEND_PORT}`
  },
  // Then add other sites
  ...Object.entries(sites)
    .filter(([domain]) => 
      !domain.includes('localhost') && 
      !domain.includes('127.0.0.1') && 
      domain !== 'default' &&
      !domain.startsWith('www.')
    )
    .map(([domain, config]) => ({
      domain,
      name: config.name || domain.split('.')[0].charAt(0).toUpperCase() + domain.split('.')[0].slice(1),
      url: isDevelopment 
        ? `http://${domain.replace('.com', '.localhost')}:${DEV_FRONTEND_PORT}`
        : `https://${domain}`
    }))
];
---

<Layout title="Multi-Tenant Platform">
  <div id="dashboard-container">
    <div class="dashboard-header">
      <div class="site-selector">
        <label for="site-select">Select Site:</label>
        <select id="site-select">
          {displaySites.map((site, index) => (
            <option value={site.url} selected={index === 0}>
              {site.name} ({site.domain})
            </option>
          ))}
        </select>
      </div>
    </div>
    
    <iframe id="site-frame" src={`${displaySites[0]?.url || 'http://welcome.localhost:4321'}`}></iframe>
  </div>

  <style>
    #dashboard-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #1a1a1a;
      color: #fff;
      font-family: system-ui, -apple-system, sans-serif;
    }

    .dashboard-header {
      padding: 1rem;
      background: #2a2a2a;
      border-bottom: 1px solid #444;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .site-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .site-selector label {
      font-weight: 500;
    }

    #site-select {
      padding: 0.5rem;
      background: #1a1a1a;
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }

    #site-frame {
      flex: 1;
      width: 100%;
      border: none;
      background: #1a1a1a;
    }
  </style>

  <script>
    // Handle site selection
    const siteSelect = document.getElementById('site-select');
    const siteFrame = document.getElementById('site-frame');
    
    siteSelect?.addEventListener('change', (e) => {
      const url = e.target.value;
      if (siteFrame) {
        // Don't add dashboardMode for welcome site
        const addDashboard = !url.includes('welcome.localhost');
        siteFrame.src = addDashboard ? `${url}?dashboardMode=true` : url;
      }
    });
  </script>
</Layout>