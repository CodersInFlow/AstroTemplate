---
import Layout from '../../../layouts/Layout.astro';

// Fetch docs from API
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://127.0.0.1:8752';
const response = await fetch(`${API_URL}/api/posts?type=docs`);
const docs = response.ok ? await response.json() : [];

// Group docs by category
const docsByCategory = docs.reduce((acc: any, doc: any) => {
  const category = doc.category_data?.name || 'Uncategorized';
  if (!acc[category]) acc[category] = [];
  acc[category].push(doc);
  return acc;
}, {});
---

<Layout title="Documentation">
  <main class="container mx-auto px-4 py-8 max-w-7xl">
    <h1 class="text-4xl font-bold mb-8">Documentation</h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Sidebar -->
      <aside class="lg:col-span-1">
        <nav class="sticky top-4">
          <h2 class="font-semibold mb-4 text-lg">Categories</h2>
          <ul class="space-y-2">
            {Object.keys(docsByCategory).map(category => (
              <li>
                <a href={`#${category.toLowerCase().replace(/\s+/g, '-')}`} 
                   class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400">
                  {category} ({docsByCategory[category].length})
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </aside>
      
      <!-- Main content -->
      <div class="lg:col-span-3">
        {Object.entries(docsByCategory).map(([category, categoryDocs]: [string, any]) => (
          <section id={category.toLowerCase().replace(/\s+/g, '-')} class="mb-12">
            <h2 class="text-2xl font-bold mb-4">{category}</h2>
            <div class="grid gap-4">
              {categoryDocs.map((doc: any) => (
                <article class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 hover:shadow-lg transition">
                  <h3 class="text-xl font-semibold mb-2">
                    <a href={`/docs/${doc.slug}`} class="hover:text-blue-600 transition">
                      {doc.title}
                    </a>
                  </h3>
                  <p class="text-gray-600 dark:text-gray-400">
                    {doc.excerpt || doc.description}
                  </p>
                </article>
              ))}
            </div>
          </section>
        ))}
      </div>
    </div>

    {docs.length === 0 && (
      <div class="text-center py-12 text-gray-500">
        <p>No documentation found.</p>
      </div>
    )}
  </main>
</Layout>